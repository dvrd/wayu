version: '3'

vars:
  BIN_DIR: ./bin
  SRC_DIR: ./src
  TEST_DIR: ./tests
  BINARY_NAME: wayu
  CONFIG_DIR: "{{.HOME}}/.config/wayu"

tasks:
  clean:
    desc: Clean build artifacts
    cmds:
      - rm -rf {{.BIN_DIR}}
      - mkdir -p {{.BIN_DIR}}

  build:
    desc: Build the wayu CLI
    deps: [clean]
    cmds:
      - mkdir -p {{.BIN_DIR}}
      - odin build {{.SRC_DIR}} -out:{{.BIN_DIR}}/{{.BINARY_NAME}} -o:speed
    sources:
      - "{{.SRC_DIR}}/**/*.odin"
    generates:
      - "{{.BIN_DIR}}/{{.BINARY_NAME}}"

  debug:
    desc: Build with full debug information and logging
    deps: [clean]
    cmds:
      - mkdir -p {{.BIN_DIR}}
      - odin build {{.SRC_DIR}} -out:{{.BIN_DIR}}/{{.BINARY_NAME}}_debug -debug
    sources:
      - "{{.SRC_DIR}}/**/*.odin"
    generates:
      - "{{.BIN_DIR}}/{{.BINARY_NAME}}_debug"

  test:
    desc: Run all unit tests with coverage report
    cmds:
      - ruby scripts/test-coverage.rb

  test:integration:
    desc: Run all integration tests
    deps: [build]
    cmds:
      - ruby {{.TEST_DIR}}/integration/run_all.rb

  test:validation:
    desc: Run validation integration tests
    deps: [build]
    cmds:
      - ruby {{.TEST_DIR}}/integration/test_validation.rb

  test:errors:
    desc: Run error handling integration tests
    deps: [build]
    cmds:
      - ruby {{.TEST_DIR}}/integration/test_errors.rb

  test:completions:
    desc: Run completions integration tests
    deps: [build]
    cmds:
      - ruby {{.TEST_DIR}}/integration/test_completions.rb

  test:all:
    desc: Run all tests (unit and integration)
    cmds:
      - task test
      - task test:integration

  run:
    desc: Build and run wayu
    deps: [build]
    cmds:
      - "{{.BIN_DIR}}/{{.BINARY_NAME}}"

  install:
    desc: Install wayu CLI to system
    deps: [build]
    cmds:
      - cp {{.BIN_DIR}}/{{.BINARY_NAME}} /usr/local/bin/{{.BINARY_NAME}}
      - chmod +x /usr/local/bin/{{.BINARY_NAME}}
      - ./{{.BIN_DIR}}/{{.BINARY_NAME}} init

  dev:
    desc: Development workflow (debug + run with args)
    deps: [debug]
    cmds:
      - "{{.BIN_DIR}}/{{.BINARY_NAME}}_debug"

  check:
    desc: Check Odin code
    cmds:
      - odin check {{.SRC_DIR}}

  all:
    desc: Clean, build, test, and install
    deps: [clean, build, test, install]

  help:
    desc: Show available tasks
    cmds:
      - task --list
