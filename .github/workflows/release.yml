name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  build-release:
    name: Build Release for ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: linux-amd64
            artifact: wayu-linux-amd64
          - os: macos-13
            target: macos-amd64
            artifact: wayu-macos-amd64
          - os: macos-latest
            target: macos-arm64
            artifact: wayu-macos-arm64

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Odin
      uses: laytan/setup-odin@v2
      with:
        release: latest

    - name: Build optimized release
      run: |
        mkdir -p bin
        odin build src -out:bin/wayu -o:speed
        chmod +x bin/wayu

    - name: Verify build
      run: ./bin/wayu version

    - name: Create release package
      run: |
        mkdir -p release
        cp bin/wayu release/
        cp README.md release/
        cd release
        tar -czf ../${{ matrix.artifact }}.tar.gz *

    - name: Upload release artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact }}
        path: ${{ matrix.artifact }}.tar.gz

  create-release:
    name: Create GitHub Release
    needs: build-release
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Extract version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Generate release notes
      run: |
        cat > release_notes.md << 'EOF'
        ## wayu ${{ steps.get_version.outputs.VERSION }}

        Shell configuration management CLI for Zsh and Bash.

        ### Downloads

        | Platform | File |
        |----------|------|
        | Linux (x86_64) | `wayu-linux-amd64.tar.gz` |
        | macOS (Intel) | `wayu-macos-amd64.tar.gz` |
        | macOS (Apple Silicon) | `wayu-macos-arm64.tar.gz` |

        ### Installation

        ```bash
        tar -xzf wayu-*.tar.gz
        sudo cp release/wayu /usr/local/bin/
        wayu init
        ```

        See [README.md](README.md) for full documentation.
        EOF

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: wayu ${{ steps.get_version.outputs.VERSION }}
        body_path: release_notes.md
        draft: false
        prerelease: false
        files: |
          artifacts/wayu-linux-amd64/wayu-linux-amd64.tar.gz
          artifacts/wayu-macos-amd64/wayu-macos-amd64.tar.gz
          artifacts/wayu-macos-arm64/wayu-macos-arm64.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
