name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Odin
      uses: laytan/setup-odin@v2
      with:
        release: latest

    - name: Verify Odin installation
      run: odin version

    - name: Build wayu
      run: |
        mkdir -p bin
        odin build src -out:bin/wayu -o:speed

    - name: Verify build output
      run: |
        ls -lh bin/wayu
        ./bin/wayu version

    - name: Setup test environment
      run: mkdir -p ~/.config/wayu/backup

    - name: Run unit tests
      run: odin test tests/unit -file -o:speed -define:ODIN_TEST_THREADS=1 -ignore-unused-defineables

    - name: Test CLI non-interactive behavior
      run: |
        # Test that CLI requires explicit arguments
        if ./bin/wayu path add 2>&1 | grep -q "Missing required arguments"; then
          echo "CLI correctly requires explicit arguments"
        else
          echo "CLI should require explicit arguments"
          exit 1
        fi

        # Test exit code
        EXIT_CODE=0
        ./bin/wayu path add > /dev/null 2>&1 || EXIT_CODE=$?
        if [ "$EXIT_CODE" -eq 64 ]; then
          echo "CLI returns correct exit code (64)"
        else
          echo "CLI should return exit code 64, got $EXIT_CODE"
          exit 1
        fi

    - name: Upload build artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: wayu-${{ matrix.os }}
        path: bin/wayu
        retention-days: 7

  lint:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Odin
      uses: laytan/setup-odin@v2
      with:
        release: latest

    - name: Check code
      run: odin check src

    - name: Build with warnings as errors
      run: |
        mkdir -p bin
        odin build src -out:bin/wayu_test -warnings-as-errors -o:speed

  release-check:
    name: Release Readiness
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check version consistency
      run: |
        VERSION=$(sed -n 's/^VERSION :: "\([0-9]*\.[0-9]*\.[0-9]*\)"/\1/p' src/main.odin)
        echo "Found version: $VERSION"

        if [ -z "$VERSION" ]; then
          echo "Could not extract version from src/main.odin"
          exit 1
        fi

        echo "Version format valid: $VERSION"

    - name: Check documentation
      run: |
        for file in README.md; do
          if [ ! -f "$file" ]; then
            echo "Missing required file: $file"
            exit 1
          fi
        done
        echo "All documentation files present"

    - name: Check for TODO/FIXME comments
      run: |
        TODO_COUNT=$(grep -r "TODO\|FIXME" src/ --include="*.odin" | wc -l || true)
        if [ "$TODO_COUNT" -gt 0 ]; then
          echo "Found $TODO_COUNT TODO/FIXME comments"
          grep -r "TODO\|FIXME" src/ --include="*.odin" || true
        else
          echo "No TODO/FIXME comments in source"
        fi
